name: CI
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  merge_group:
    types:
      - checks_requested

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run TypeScript unit tests
        run: yarn test --maxWorkers=2 --coverage

  build-android:
    runs-on: ubuntu-latest
    env:
      GRADLE_FLAGS: "--build-cache --parallel --configuration-cache --configuration-cache-problems=warn"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build library
        run: yarn prepare

      - name: Install JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Cache Android build cache
        uses: actions/cache@v4
        with:
          path: ~/.android/build-cache
          key: android-build-cache-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/gradle/libs.versions.toml', '**/settings.gradle*') }}
          restore-keys: |
            android-build-cache-${{ runner.os }}-

      - name: Build example for Android
        env:
          JAVA_OPTS: "-XX:MaxHeapSize=6g"
        run: |
          cd example/android
          ./gradlew :app:assembleDebug $GRADLE_FLAGS

  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build library
        run: yarn prepare

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            example/ios/Pods
            ~/.cocoapods
            ~/Library/Caches/CocoaPods
          key: ${{ runner.os }}-cocoapods-${{ hashFiles('example/ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-cocoapods-

      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: example/ios/DerivedData
          key: ${{ runner.os }}-derived-data-${{ hashFiles('example/ios/Podfile.lock', 'example/ios/*.xcodeproj/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-derived-data-

      - name: Install CocoaPods
        run: |
          cd example/ios
          pod install --repo-update
        env:
          NO_FLIPPER: 1

      - name: Prebuild CocoaPods targets
        run: |
          xcodebuild \
            -workspace example/ios/example.xcworkspace \
            -scheme Pods-example \
            -configuration Debug \
            -destination 'generic/platform=iOS' \
            -derivedDataPath example/ios/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Build example for iOS
        run: |
          xcodebuild \
            -workspace example/ios/example.xcworkspace \
            -scheme example \
            -configuration Debug \
            -destination 'generic/platform=iOS' \
            -derivedDataPath example/ios/DerivedData \
            CODE_SIGNING_ALLOWED=NO \
            build
